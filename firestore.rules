/**
 * # Core Philosophy
 * This ruleset enforces a strict user-ownership model. The fundamental principle is that users can only access data that exists within their own data tree. There is no concept of public data or shared data between users. This provides strong isolation and security by default.
 *
 * # Data Structure
 * The data is organized hierarchically. All user-specific information, including their profile and their tasks, is nested under a top-level `users` collection, keyed by the user's unique authentication ID (UID).
 *   - `/users/{userId}`: Contains the user's profile document.
 *   - `/users/{userId}/tasks/{taskId}`: A subcollection containing all tasks created by that user.
 *
 * # Key Security Decisions
 * - **No User Enumeration**: Listing the top-level `/users` collection is explicitly disallowed to prevent malicious actors from discovering all users of the application.
 * - **Path-Based Security**: Authorization is primarily determined by the document path. If a user's UID matches the `{userId}` segment of the path, they are considered the owner. This is fast, efficient, and avoids costly database lookups (`get()` calls) in rules.
 * - **Relational Integrity**: On creation, rules validate that internal ID fields (e.g., `Task.userId`) match the IDs in the document path. On update, these IDs are enforced as immutable to prevent documents from being "moved" between owners.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the core of the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the user is the owner AND the document already exists.
     * Used for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates required relational fields on User document creation.
     * Ensures the document's internal ID matches its path ID.
     */
    function isValidUserCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Enforces immutability for the User's core ID field on update.
     */
    function isImmutableUserId() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates required relational fields on Task document creation.
     * Ensures the task's internal IDs match its path IDs.
     */
    function isValidTaskCreate(userId, taskId) {
      return request.resource.data.userId == userId && request.resource.data.id == taskId;
    }

    /**
     * Enforces immutability for the Task's core relational fields on update.
     */
    function isImmutableTaskFields() {
      return request.resource.data.userId == resource.data.userId && request.resource.data.id == resource.data.id;
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages user profile documents. Only the owner of the profile can read, create, update, or delete it. Listing all users is forbidden.
     * @path /users/{userId}
     * @allow (get) An authenticated user with uid 'user_abc' requests `/users/user_abc`.
     * @deny (list) Any user, authenticated or not, attempts to list the `/users` collection.
     * @deny (update) An authenticated user with uid 'user_xyz' attempts to update `/users/user_abc`.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isValidUserCreate(userId);
      allow update: if isExistingOwner(userId) && isImmutableUserId();
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages tasks, which are stored in a subcollection under the user who owns them. Access is restricted entirely to the owner.
     * @path /users/{userId}/tasks/{taskId}
     * @allow (create) An authenticated user with uid 'user_abc' creates a new task at `/users/user_abc/tasks/task_123`.
     * @allow (list) An authenticated user with uid 'user_abc' lists all tasks at `/users/user_abc/tasks`.
     * @deny (get) An authenticated user with uid 'user_xyz' attempts to read `/users/user_abc/tasks/task_123`.
     * @principle Enforces strict document ownership within a user's private subcollection.
     */
    match /users/{userId}/tasks/{taskId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isValidTaskCreate(userId, taskId);
      allow update: if isExistingOwner(userId) && isImmutableTaskFields();
      allow delete: if isExistingOwner(userId);
    }
  }
}